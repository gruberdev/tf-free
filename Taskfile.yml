version: "3"

tasks:
  default:
    cmds:
      - task: clean
      - task: tf-clean
      - task: generate
      - task: vet
      - task: fmt
      - task: lint
      - task: test
      - task: mod

  docker-init:
    desc: Create and cache your Docker container
    cmds:
      - docker volume rm cache_terraform || true
      - docker volume rm repository_results || true
      - docker volume create cache_terraform || true
      - docker volume create repository_results || true

  docker:
    desc: Create and cache your Docker container
    cmds:
      - docker build -t tf-free:latest .
      - docker run -it --rm --name tf-free -e GOOGLE_PROJECT=${GOOGLE_PROJECT} -v cache_terraform:/project -v repository_results:/root/.ssh tf-free:latest task docker-test

  docker-test:
    desc: Run tests from inside your container
    cmds:
      - gcloud auth login
      - cd test && go mod init "github.com/gruberdev/tf-free" || true
      - cd test && go mod tidy
      - cd test && go test -v -timeout 5m -run TestUnitCompute
      - cd test && go test -v -timeout 5m -run TestUnitVPC
      - cd test && go test -v -timeout 10m -run TestIntegrationGCP

  build-all:
    desc: Build executable binary with GoReleaser.
    cmds:
      - goreleaser --snapshot --skip-publish --rm-dist

  generate:
    desc: Initialize test fakes
    cmds:
      - go generate ./...

  vet:
    desc: Initialize module and build cache, and remake go.sum file.
    cmds:
      - go vet ./...

  fmt:
    desc: Format Go files
    cmds:
      - go fmt ./...

  mod:
    desc: Initialize module and build cache, and remake go.sum file on root directory.
    cmds:
      - go mod tidy
      - cd tools && go mod tidy

  docs:
    desc: Build documentation using Terraform-docs and the task command
    cmds:
      - terraform-docs markdown . --output-file README.md
      - cd modules/aws && terraform-docs markdown . --output-file README.md
      - cd modules/aws/ec2 && terraform-docs markdown . --output-file README.md
      - cd modules/aws/firewall && terraform-docs markdown . --output-file README.md
      - cd modules/aws/vpc && terraform-docs markdown . --output-file README.md
      - cd modules/aws/subnet && terraform-docs markdown . --output-file README.md
      - cd modules/aws/gateway && terraform-docs markdown . --output-file README.md
      - cd modules/aws/rds && terraform-docs markdown . --output-file README.md
      - cd modules/gcp && terraform-docs markdown . --output-file README.md
      - cd modules/gcp/compute && terraform-docs markdown . --output-file README.md
      - cd modules/gcp/firewall && terraform-docs markdown . --output-file README.md
      - cd modules/gcp/vpc && terraform-docs markdown . --output-file README.md

  test:
    desc: Test and print out code coverage as html.
    cmds:
      - go test -race -covermode=atomic -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html

  lint:
    desc: Linter built on Docker.
    cmds:
      - go mod verify
      - docker run --rm -v $(pwd):/app -w /app golangci/golangci-lint:v1.40.1 golangci-lint run --enable gosec --timeout 3m0s ./...
    sources:
      - ./go.mod
      - "**/*.go"

  clean:
    desc: Clean cache on root module.
    cmds:
      - rm -f ./go.sum
      - go clean -cache || true
      - go clean -modcache || true

  graph:
    desc: Create beautiful Terraform Graphs
    cmds:
      - go get github.com/pcasteran/terraform-graph-beautifier
      - terraform graph | terraform-graph-beautifier --exclude="module.root.provider" --output-type=cyto-html > graph.html

  tf-test-clean:
    desc: Clean cache on Terraform test cache.
    cmds:
      - cd test && rm ./go.sum && ./go.mod
      - go clean -cache || true
      - go clean -modcache || true

  gcp-test:
    desc: Terraform testing (GCP modules)
    cmds:
      - cd test/gcp && rm go.mod || true
      - cd test/gcp && rm go.sum || true
      - cd test/gcp && go mod init "github.com/gruberdev/tf-free" && go mod tidy
      - cd test/gcp && go test -v -timeout 10m -run TestIntegrationGCP

  aws-test:
    desc: Terraform testing (AWS modules)
    cmds:
      - cd test/aws && go mod init "github.com/gruberdev/tf-free" && go mod tidy
      - cd test/aws && go test -v -timeout 5m -run TestUnitEC2

  tf-init:
    desc: Terraform standard initialization
    cmds:
      - terraform init -upgrade

  apply:
    desc: Terraform standard initialization
    cmds:
      - terraform apply -auto-approve

  apply-aws:
    desc: Terraform standard initialization
    cmds:
      - cd modules/aws && terraform apply -auto-approve

  apply-gcp:
    desc: Terraform standard initialization
    cmds:
      - cd modules/gcp && terraform apply -auto-approve

  destroy-gcp:
    desc: Terraform standard initialization
    cmds:
      - cd modules/gcp && terraform destroy -auto-approve

  destroy-aws:
    desc: Terraform standard initialization
    cmds:
      - cd modules/aws && terraform destroy -auto-approve

  restart-aws:
    desc: Terraform standard initialization
    cmds:
      - cd modules/aws && terraform destroy -auto-approve
      - cd modules/aws && terraform apply -auto-approve

  tf-clean:
    desc: Terraform standard initialization
    cmds:
      - rm -rf ./.terraform
      - rm terraform.tfstate
      - rm terraform.tfstate.backup
      - rm ./.terraform.lock.hcl
      - cd modules && cd gcp && rm -rf ./.terraform && rm ./.terraform.lock.hcl
      - cd modules && cd gcp && cd vpc && rm -rf ./.terraform && rm ./.terraform.lock.hcl
      - cd modules && cd gcp && cd firewall && rm -rf ./.terraform && rm ./.terraform.lock.hcl
      - cd modules && cd gcp && cd compute && rm -rf ./.terraform && rm ./.terraform.lock.hc

  init-drone:
    desc: Terraform standard initialization
    cmds:
      - apk add build-base git
      - apk add --no-cache terraform --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community

  get-keys:
    desc: Get GCP keys
    cmds:
      - echo $GCP_SERVICE_ACCOUNT > gcp.json
      - echo $GCP_SERVICE_ACCOUNT > examples/gcp/e2e/gcp.json
      - echo $GCP_SERVICE_ACCOUNT > examples/gcp/unit/compute/gcp.json
      - echo $GCP_SERVICE_ACCOUNT > examples/gcp/unit/vpc/gcp.json
      - echo $GCP_SERVICE_ACCOUNT > modules/gcp/compute/gcp.json
      - echo $GCP_SERVICE_ACCOUNT > modules/gcp/vpc/gcp.json
      - echo $GCP_SERVICE_ACCOUNT > modules/gcp/firewall/gcp.json
      - echo $GCP_SERVICE_ACCOUNT > modules/gcp/gcp.json

  drone-gcp:
    desc: Terraform standard initialization
    cmds:
      - cd test/gcp && go mod init "github.com/gruberdev/tf-free" || true
      - cd test/gcp && go mod tidy

  unit-compute-gcp:
    desc: Terraform standard initialization
    cmds:
      - cd test/gcp && go test -v -timeout 5m -run TestUnitCompute
  unit-network-gcp:
    desc: Terraform standard initialization
    cmds:
      - cd test/gcp && go test -v -timeout 5m -run TestUnitVPC
  integration-gcp:
    desc: Terraform standard initialization
    cmds:
      - cd test/gcp && go test -v -timeout 10m -run TestIntegrationGCP
